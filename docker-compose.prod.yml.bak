version: '3.8'

services:
  # Plasmic WAB (Web App Builder) - Production
  app:
    build:
      context: .
      dockerfile: Dockerfile.prod-node21
    restart: always
    volumes:
      # For production, we don't need to mount source code for development
      # Only mount logs or configuration files if needed
      - plasmic_logs:/app/logs
    ports:
      - "3003:3003"
      - "3004:3004"
      - "3005:3005"
    environment:
      # Database configuration for remote connection
      - DATABASE_URI=postgresql://wab:SEKRET@142.44.136.233:5433/plasmic-db
      - WAB_DBHOST=142.44.136.233
      - WAB_DBPORT=5433
      - WAB_DBUSER=wab
      - WAB_DBPASSWORD=SEKRET
      - WAB_DBNAME=plasmic-db
      - NODE_ENV=production
      - PUBLIC_URL=http://your-production-domain.com
      - SESSION_SECRET=your-production-session-secret-key
      - PLASMIC_DEPLOYMENT_ENV=production
    # Run migration command before starting the main application
    command: sh -c "sleep 10 && cd /app/platform/wab && yarn typeorm migration:run && yarn backend"
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:3004/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  plasmic_logs: