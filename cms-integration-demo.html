<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plasmic CMS Integration Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .demo-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .builder-container {
            display: none;
            width: 100%;
            height: 800px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .builder-container.active {
            display: block;
        }

        .builder-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #666;
        }

        .token-display {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            word-break: break-all;
            margin: 15px 0;
            display: none;
        }

        .token-display.active {
            display: block;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .demo-section {
                padding: 20px;
            }

            .builder-container {
                height: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Plasmic CMS Integration Demo</h1>
            <p>Embed the Plasmic Web Builder in your CMS with seamless authentication</p>
        </div>

        <div class="demo-section">
            <h2 class="section-title">üìù Authentication</h2>
            <div class="auth-section">
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" placeholder="Enter user ID (e.g., e2e384a5-c08d-40d1-bdb1-15832cfb272f)"
                           value="e2e384a5-c08d-40d1-bdb1-15832cfb272f">
                </div>

                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="Enter user email"
                           value="admin@admin.example.com">
                </div>

                <div class="form-group">
                    <label for="firstName">First Name:</label>
                    <input type="text" id="firstName" placeholder="Enter first name"
                           value="Admin">
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name:</label>
                    <input type="text" id="lastName" placeholder="Enter last name"
                           value="User">
                </div>

                <div class="form-group">
                    <label for="workspaceId">Workspace ID (Optional):</label>
                    <input type="text" id="workspaceId" placeholder="Enter workspace ID to filter projects">
                </div>

                <button id="authenticateBtn" class="btn">Generate Token & Load Projects</button>
            </div>

            <div id="statusMessage" class="status"></div>

            <div id="tokenDisplay" class="token-display">
                <strong>Generated JWT Token:</strong>
                <div id="tokenText"></div>
            </div>

            <div class="instructions">
                <h3>üìã How This Works:</h3>
                <ol>
                    <li>Enter user details from your CMS system</li>
                    <li>Click "Generate Token & Load Projects" to authenticate</li>
                    <li>The system generates a secure JWT token</li>
                    <li>The Plasmic projects list page opens in the embedded view below</li>
                    <li>User is automatically logged in and can access their projects</li>
                    <li>Use the "Create New Project" button in the section below to start a new project</li>
                </ol>
            </div>
        </div>

        <!-- Projects Actions Section -->
        <div class="demo-section">
            <h2 class="section-title">üéØ Project Actions</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <button id="viewProjectsBtn" class="btn" style="flex: 1; min-width: 200px;">
                    üìÅ View All Projects
                </button>
                
                <button id="createProjectBtn" class="btn" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #4CAF50, #45a049);">
                    ‚ûï Create New Project
                </button>
                
                <button id="manageProjectsBtn" class="btn" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #2196F3, #1976D2);">
                    üìã Manage Projects
                </button>
            </div>
        </div>

        <!-- Projects List iFrame Section -->
        <div class="demo-section" id="projectsSection">
            <h2 class="section-title">üìä Plasmic Projects List</h2>
            <div id="projectsContainer" class="builder-container" style="height: 700px;">
                <iframe id="projectsIframe" class="builder-iframe" src="" title="Plasmic Projects List"></iframe>
            </div>
            <p style="margin-top: 15px; color: #666; font-style: italic;">
                This iframe embeds the Plasmic projects list page directly. After authentication, the projects will load automatically.
            </p>
        </div>

        <!-- Project Detail iFrame Section -->
        <div id="builderContainer" class="builder-container" style="margin-top: 30px;">
            <iframe id="builderIframe" class="builder-iframe" src="" title="Plasmic Web Builder"></iframe>
        </div>

        <!-- CMS Integration Example Section -->
        <div class="demo-section" id="cmsIntegrationSection">
            <h2 class="section-title">üõ†Ô∏è CMS Integration Example</h2>
            <div class="cms-integration-content">
                <p style="margin-bottom: 20px; color: #666;">
                    This demonstrates how to integrate Plasmic into your CMS. When a user clicks to edit a page in your CMS,
                    you can use the token to automatically authenticate them in Plasmic.
                </p>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">Example: Your CMS Page Editor</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="color: #555; margin-bottom: 10px;">Page: Home Page</h4>
                            <p style="color: #777; margin-bottom: 15px;">This page is connected to Plasmic project: tH77ekFNugan8Yv3d3xJez</p>
                            <button id="openPlasmicBtn" class="btn" style="width: 100%;">
                                ‚úèÔ∏è Edit in Plasmic Builder
                            </button>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="color: #555; margin-bottom: 10px;">Page: About Page</h4>
                            <p style="color: #777; margin-bottom: 15px;">This page is connected to Plasmic project: gmeH6XgPaBtkt51HunAo4g</p>
                            <button id="openPlasmicBtn2" class="btn" style="width: 100%;">
                                ‚úèÔ∏è Edit in Plasmic Builder
                            </button>
                        </div>
                    </div>
                </div>

                <div id="cmsStatusMessage" class="status" style="margin-top: 15px;"></div>

                <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <h4 style="color: #1a73e8; margin-bottom: 10px;">How This Works in Your CMS:</h4>
                    <ol style="padding-left: 20px; color: #333;">
                        <li style="margin-bottom: 8px;">User clicks "Edit in Plasmic" in your CMS</li>
                        <li style="margin-bottom: 8px;">Your CMS backend calls Plasmic's token generation API</li>
                        <li style="margin-bottom: 8px;">Plasmic returns a JWT token for the authenticated user</li>
                        <li style="margin-bottom: 8px;">Your CMS constructs the URL: <code>http://localhost:3003/p/{projectId}?token={jwtToken}</code></li>
                        <li>User is automatically logged in to Plasmic and taken to the specific project</li>
                    </ol>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° Important Notes:</h4>
                    <ul style="padding-left: 20px; color: #856404;">
                        <li style="margin-bottom: 8px;">The JWT token authenticates the user automatically in Plasmic</li>
                        <li style="margin-bottom: 8px;">If the studio appears blank, it may be due to an auth issue or an invalid token</li>
                        <li style="margin-bottom: 8px;">Make sure your backend API key is correctly configured</li>
                        <li style="margin-bottom: 8px;">The token has a 7-day expiration time</li>
                        <li style="margin-bottom: 8px;">For production, ensure proper HTTPS and security measures</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const authenticateBtn = document.getElementById('authenticateBtn');
            const userIdInput = document.getElementById('userId');
            const userEmailInput = document.getElementById('userEmail');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const workspaceIdInput = document.getElementById('workspaceId');
            const statusMessage = document.getElementById('statusMessage');
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenText = document.getElementById('tokenText');
            const builderContainer = document.getElementById('builderContainer');
            const builderIframe = document.getElementById('builderIframe');
            const projectsContainer = document.getElementById('projectsContainer');
            const projectsIframe = document.getElementById('projectsIframe');;

            // Demo JWT token for the seeded admin user (actual ID: e2e384a5-c08d-40d1-bdb1-15832cfb272f)
            // This is a valid token generated from the database seeded user
            const demoToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJlMmUzODRhNS1jMDhkLTQwZDEtYmRiMS0xNTgzMmNmYjI3MmYiLCJlbWFpbCI6ImFkbWluQGFkbWluLmV4YW1wbGUuY29tIiwiZmlyc3ROYW1lIjoiQWRtaW4iLCJsYXN0TmFtZSI6IlVzZXIiLCJpYXQiOjE3NjIzNjM1ODAsImV4cCI6MTc2Mjk2ODM4MH0.NC8rNWe50_82qcEscOwCbAFrDAnIysFIwCiSHCmAkb4';

            authenticateBtn.addEventListener('click', async function() {
                const userId = userIdInput.value.trim();
                const email = userEmailInput.value.trim();
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();

                // Validation
                if (!userId || !email) {
                    showStatus('User ID and Email are required!', 'error');
                    return;
                }

                if (!isValidEmail(email)) {
                    showStatus('Please enter a valid email address!', 'error');
                    return;
                }

                showStatus('Authenticating and generating token...', 'success');
                authenticateBtn.disabled = true;

                try {
                    // In a real implementation, you would call your CMS backend to generate the token
                    console.log('In a real implementation, this would call your CMS backend to generate a JWT token');

                    // Simulate the API call that would happen in a real implementation
                    // Uncomment this section when you have your backend API set up:
                    const response = await fetch('http://localhost:3004/api/v1/cms-integration/generate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'test_cms_api_key_12345' // Default test API key
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            tenant_id: "default_tenant", // Adding required tenant_id
                            email: email,
                            firstName: firstName,
                            lastName: lastName,
                            workspace_id: workspaceIdInput.value.trim() // Adding workspace_id if provided
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Show the generated token
                    tokenText.textContent = data.token;
                    tokenDisplay.classList.add('active');

                    // Load the projects list iframe with the generated token and workspace ID
                    loadProjectsList(data.token, workspaceIdInput.value.trim());

                    showStatus('Successfully authenticated! Loading your projects...', 'success');
                    /*
                    // For fallback, uncomment this section if the API is not working
                    // Load the projects list with demo token and workspace ID
                    loadProjectsList(demoToken, workspaceIdInput.value.trim());

                    showStatus('Successfully authenticated! Loading your projects...', 'success');
                    */

                } catch (error) {
                    console.error('Authentication error:', error);
                    showStatus(`Authentication failed: ${error.message}`, 'error');
                    projectsContainer.classList.remove('active');
                    builderContainer.classList.remove('active');
                } finally {
                    authenticateBtn.disabled = false;
                }
            });

            function loadProjectsList(token, workspaceId = null) {
                // Set the iframe source to the Plasmic projects list page with the token
                // The main projects page in Plasmic is at the root URL with the token
                const projectsUrl = `http://localhost:3003/?token=${token}`;
                
                projectsIframe.src = projectsUrl;

                // Show the projects container
                projectsContainer.classList.add('active');

                // Hide the builder container since we're showing projects
                builderContainer.classList.remove('active');

                // Log for debugging
                console.log(`Loading projects list with URL: ${projectsUrl}`);
            }

            function openProjectInBuilder(projectId, token) {
                // Set the iframe source to the specific project with the token
                // The correct format is http://localhost:3003/projects/{projectId}?token={jwtToken}
                const projectUrl = `http://localhost:3003/projects/${projectId}?token=${token}`;

                openProjectInBuilderWithUrl(projectUrl, projectId);
            }

            function openProjectInBuilderWithUrl(projectUrl, projectId) {
                // Set the iframe source to the specific project with the token
                builderIframe.src = projectUrl;

                // Show the builder container
                builderContainer.classList.add('active');

                // Hide the projects container since we're showing a specific project
                projectsContainer.classList.remove('active');

                // Scroll to the builder
                builderContainer.scrollIntoView({ behavior: 'smooth' });

                showStatus(`Opening project "${projectId}" in Plasmic Builder...`, 'success');

                // Log to console for debugging
                console.log(`Opening project with URL: ${projectUrl}`);
            }

            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status';
                statusMessage.classList.add(type);
            }

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // CMS Integration Demo Functions
            document.getElementById('openPlasmicBtn').addEventListener('click', function() {
                // Use the current token if available, or fall back to demo token
                const tokenElement = document.getElementById('tokenText');
                const token = tokenElement.textContent || demoToken;
                const projectId = 'tH77ekFNugan8Yv3d3xJez';

                showCmsStatus(`Opening Home Page in Plasmic Builder with token...`, 'success');

                // Validate that we have a valid token
                if (!token || token === '') {
                    showCmsStatus('No token available. Please authenticate first using the form above.', 'error');
                    return;
                }

                // Simulate the backend call that would happen in a real CMS
                setTimeout(() => {
                    let plasmicUrl;
                    const workspaceIdValue = document.getElementById('workspaceId')?.value.trim();
                    if (workspaceIdValue) {
                        // If workspaceId is provided, direct to the specific project within the workspace
                        plasmicUrl = `http://localhost:3003/workspaces/${workspaceIdValue}/projects/${projectId}?token=${token}#tab=projects`;
                    } else {
                        // Otherwise use the general project URL
                        plasmicUrl = `http://localhost:3003/projects/${projectId}?token=${token}`;
                    }
                    showCmsStatus(`Generated URL: <a href="${plasmicUrl}" target="_blank">${plasmicUrl}</a>`, 'success');

                    // Log to console for debugging
                    console.log(`Opening project with URL: ${plasmicUrl}`);
                    console.log(`Token being used: ${token}`);

                    // In a real implementation, you would open this URL in a new window/tab
                    // window.open(plasmicUrl, '_blank');

                    // For demo purposes, also load it in the builder iframe
                    openProjectInBuilderWithUrl(plasmicUrl, projectId);
                }, 1000);
            });

            document.getElementById('openPlasmicBtn2').addEventListener('click', function() {
                // Use the current token if available, or fall back to demo token
                const tokenElement = document.getElementById('tokenText');
                const token = tokenElement.textContent || demoToken;
                const projectId = 'gmeH6XgPaBtkt51HunAo4g';

                showCmsStatus(`Opening About Page in Plasmic Builder with token...`, 'success');

                // Validate that we have a valid token
                if (!token || token === '') {
                    showCmsStatus('No token available. Please authenticate first using the form above.', 'error');
                    return;
                }

                // Simulate the backend call that would happen in a real CMS
                setTimeout(() => {
                    let plasmicUrl;
                    const workspaceIdValue = document.getElementById('workspaceId')?.value.trim();
                    if (workspaceIdValue) {
                        // If workspaceId is provided, direct to the specific project within the workspace
                        plasmicUrl = `http://localhost:3003/workspaces/${workspaceIdValue}/projects/${projectId}?token=${token}#tab=projects`;
                    } else {
                        // Otherwise use the general project URL
                        plasmicUrl = `http://localhost:3003/projects/${projectId}?token=${token}`;
                    }
                    showCmsStatus(`Generated URL: <a href="${plasmicUrl}" target="_blank">${plasmicUrl}</a>`, 'success');

                    // Log to console for debugging
                    console.log(`Opening project with URL: ${plasmicUrl}`);
                    console.log(`Token being used: ${token}`);

                    // In a real implementation, you would open this URL in a new window/tab
                    // window.open(plasmicUrl, '_blank');

                    // For demo purposes, also load it in the builder iframe
                    openProjectInBuilderWithUrl(plasmicUrl, projectId);
                }, 1000);
            });

            function showCmsStatus(message, type) {
                const cmsStatus = document.getElementById('cmsStatusMessage');
                cmsStatus.innerHTML = message;
                cmsStatus.className = 'status';
                cmsStatus.classList.add(type);
            }
            
            // Project Actions Functions
            document.getElementById('viewProjectsBtn').addEventListener('click', function() {
                const tokenElement = document.getElementById('tokenText');
                const currentToken = tokenElement.textContent || demoToken;
                
                if (currentToken && currentToken !== '') {
                    loadProjectsList(currentToken, document.getElementById('workspaceId')?.value.trim());
                    showStatus('Projects page reloaded. Look for "New Project" button in the embedded view.', 'success');
                } else {
                    showStatus('Please authenticate first to view projects.', 'error');
                }
            });
            
            document.getElementById('createProjectBtn').addEventListener('click', function() {
                const tokenElement = document.getElementById('tokenText');
                const currentToken = tokenElement.textContent || demoToken;
                
                if (currentToken && currentToken !== '') {
                    // Load the projects page which contains the "New Project" button
                    if (projectsIframe) {
                        let newProjectUrl;
                        const workspaceIdValue = document.getElementById('workspaceId')?.value.trim();
                        if (workspaceIdValue) {
                            // If workspaceId is provided, use the specific workspace projects path
                            newProjectUrl = `http://localhost:3003/workspaces/${workspaceIdValue}?token=${currentToken}#tab=projects`;
                        } else {
                            // Otherwise use the default projects path
                            newProjectUrl = `http://localhost:3003/?token=${currentToken}`;
                        }
                        projectsIframe.src = newProjectUrl;
                        
                        // Show the projects container
                        projectsContainer.classList.add('active');
                        builderContainer.classList.remove('active');
                        
                        showStatus('Projects page loaded. Click "New Project" in the embedded view to create a project.', 'success');
                        console.log(`Loading projects page for new project creation with URL: ${newProjectUrl}`);
                    }
                } else {
                    showStatus('Please authenticate first to create projects.', 'error');
                }
            });
            
            document.getElementById('manageProjectsBtn').addEventListener('click', function() {
                const tokenElement = document.getElementById('tokenText');
                const currentToken = tokenElement.textContent || demoToken;
                
                if (currentToken && currentToken !== '') {
                    // Show the projects iframe if not already visible
                    if (!projectsContainer.classList.contains('active')) {
                        loadProjectsList(currentToken, document.getElementById('workspaceId')?.value.trim());
                    }
                    showStatus('Projects list is now visible. Manage your projects in the embedded view below.', 'success');
                } else {
                    showStatus('Please authenticate first to view projects.', 'error');
                }
            });
        });
    </script>
</body>
</html>